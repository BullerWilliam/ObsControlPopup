<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YouTube Live Chat Overlay</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

#container {
    width: 800px;
    height: 600px;
    display: none;
    overflow-y: auto;
}

.message {
    color: white;
    font-size: 18px;
    margin-bottom: 8px;
}

.name {
    font-weight: bold;
    color: #00ffcc;
}

.status {
    color: white;
    font-size: 20px;
}
</style>
</head>
<body>

<div id="container"></div>

<script>
let apiKey = "AIzaSyArsE7xFU4H3Yln1z13DXLby2ASWT8TFuo"
let container = document.getElementById("container")
let chatId = null
let nextPage = ""
let pollTime = 3000
let polling = false

function extractChannel(input) {
    input = input.trim()
    if (input.startsWith("http")) {
        let parts = input.split("/")
        return parts[parts.length - 1]
    }
    return input
}

async function getChannelId(input) {
    input = extractChannel(input)
    if (input.startsWith("UC")) return input
    if (input.startsWith("@")) {
        let r = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${input.slice(1)}&key=${apiKey}`)
        let j = await r.json()
        if (j.items && j.items.length) return j.items[0].id
    }
    let r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${input}&key=${apiKey}`)
    let j = await r.json()
    if (j.items && j.items.length) return j.items[0].snippet.channelId
    return null
}

async function getLiveVideo(channelId) {
    let r = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&eventType=live&type=video&key=${apiKey}`)
    let j = await r.json()
    if (j.items && j.items.length) return j.items[0].id.videoId
    return null
}

async function getChatId(videoId) {
    let r = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${apiKey}`)
    let j = await r.json()
    return j.items[0].liveStreamingDetails.activeLiveChatId || null
}

async function pollChat() {
    if (!polling || !chatId) return
    let r = await fetch(`https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${chatId}&part=snippet,authorDetails&pageToken=${nextPage}&key=${apiKey}`)
    let j = await r.json()
    pollTime = j.pollingIntervalMillis || 3000
    nextPage = j.nextPageToken || nextPage
    if (j.items.length) {
        let status = document.querySelector(".status")
        if (status) status.remove()
    }
    j.items.forEach(m => {
        let div = document.createElement("div")
        div.className = "message"
        div.innerHTML = `<span class="name">${m.authorDetails.displayName}</span>: ${m.snippet.displayMessage}`
        container.appendChild(div)
        container.scrollTop = container.scrollHeight
    })
    setTimeout(pollChat, pollTime)
}

document.addEventListener("keydown", async e => {
    if (e.code === "Space") {
        e.preventDefault()
        polling = false
        container.innerHTML = ""
        container.style.display = "block"
        let input = prompt("Enter channel (@handle, URL, or channel ID)")
        if (!input) return
        let channelId = await getChannelId(input)
        if (!channelId) {
            container.textContent = "Channel not found"
            return
        }
        let videoId = await getLiveVideo(channelId)
        if (!videoId) {
            container.textContent = "No active livestream"
            return
        }
        chatId = await getChatId(videoId)
        if (!chatId) {
            container.textContent = "Live chat unavailable"
            return
        }
        let status = document.createElement("div")
        status.className = "status"
        status.textContent = "Waiting for chat messages..."
        container.appendChild(status)
        nextPage = ""
        polling = true
        pollChat()
    }
})
</script>

</body>
</html>
